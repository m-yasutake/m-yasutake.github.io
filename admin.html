<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Tomika Bikes â€“ Admin dashboard. Manage posts, photos, and settings." />
  <title>Admin â€“ Tomika Bikes</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš´</text></svg>" />

  <style>
    body { background: var(--color-gray-100); }

    .admin-gate {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      padding-top: calc(var(--nav-height) + 2rem);
    }

    .admin-gate-card {
      background: var(--color-white);
      border-radius: var(--radius-xl);
      padding: 3rem;
      max-width: 440px;
      width: 100%;
      text-align: center;
      box-shadow: var(--shadow-xl);
    }

    .admin-gate-card .lock-icon { font-size: 3.5rem; margin-bottom: 1rem; }
    .admin-gate-card h2 { margin-bottom: .5rem; }
    .admin-gate-card > p { color: var(--color-gray-600); margin-bottom: 2rem; }

    .admin-section { margin-bottom: 2rem; }

    .admin-section > h2 {
      font-size: 1.25rem;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: .6rem;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .quick-action {
      background: var(--color-white);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      border: 1px solid var(--color-gray-200);
      cursor: pointer;
      transition: all var(--transition);
      text-align: center;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .6rem;
    }

    .quick-action:hover {
      border-color: var(--color-secondary);
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .quick-action .qa-icon { font-size: 1.75rem; }
    .quick-action h4 { font-size: .9rem; margin: 0; }
    .quick-action p  { font-size: .78rem; color: var(--color-gray-600); margin: 0; }

    .activity-list { }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: .9rem;
      border-radius: var(--radius-md);
      transition: background var(--transition);
    }

    .activity-item:hover { background: var(--color-gray-100); }

    .activity-icon {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: rgba(42,157,143,.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .activity-body { flex: 1; }
    .activity-body strong { font-size: .875rem; display: block; }
    .activity-body span  { font-size: .78rem; color: var(--color-gray-600); }

    .activity-time { font-size: .75rem; color: var(--color-gray-400); }

    /* New post form */
    .new-post-form {
      background: var(--color-white);
      border-radius: var(--radius-lg);
      padding: 2rem;
      border: 1px solid var(--color-gray-200);
      box-shadow: var(--shadow-sm);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }

    /* â”€â”€ Roots Admin CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* â”€â”€ Auth gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #roots-auth-gate {
    text-align: center;
    padding: 3em 1em;
    color: #888;
  }

  #roots-auth-gate .roots-btn {
    font-size: 1.1em;
    padding: 0.6em 1.5em;
    margin-top: 1em;
  }

  #roots-admin-content { display: none; }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .admin-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em;
    margin-bottom: 1em;
    align-items: center;
  }

  .roots-btn {
    padding: 0.4em 0.8em;
    background: #252a34;
    border: 1px solid #444;
    border-radius: 4px;
    color: #e0e0e0;
    cursor: pointer;
    font-size: 0.85em;
  }

  .roots-btn:hover { border-color: #58a6ff; }
  .roots-btn.active { border-color: #58a6ff; background: #1a1f2e; }
  .roots-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .roots-btn.primary {
    background: #1a3a5c;
    border-color: #58a6ff;
  }

  .roots-btn.danger {
    border-color: #ff6b6b;
    color: #ff6b6b;
  }

  .roots-btn.danger:hover {
    background: rgba(255, 107, 107, 0.15);
  }

  /* â”€â”€ Collection tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .collection-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 1em;
    border-bottom: 2px solid #333;
  }

  .collection-tab {
    padding: 0.6em 1.2em;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: #888;
    cursor: pointer;
    font-size: 0.95em;
    margin-bottom: -2px;
  }

  .collection-tab:hover { color: #e0e0e0; }
  .collection-tab.active {
    color: #58a6ff;
    border-bottom-color: #58a6ff;
  }

  /* â”€â”€ Filter bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em;
    margin-bottom: 1em;
    align-items: center;
  }

  .filter-bar select, .filter-bar input[type="text"] {
    padding: 0.4em 0.6em;
    background: #252a34;
    border: 1px solid #444;
    border-radius: 4px;
    color: #e0e0e0;
    font-size: 0.85em;
  }

  .filter-bar select:focus, .filter-bar input[type="text"]:focus {
    outline: none;
    border-color: #58a6ff;
  }

  /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .admin-table-wrap {
    overflow-x: auto;
    margin-bottom: 1em;
    border: 1px solid #333;
    border-radius: 6px;
  }

  #roots-data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85em;
    min-width: 600px;
  }

  #roots-data-table th {
    background: #1a1f2e;
    color: #58a6ff;
    padding: 0.5em 0.6em;
    text-align: left;
    border-bottom: 2px solid #444;
    position: sticky;
    top: 0;
    white-space: nowrap;
    user-select: none;
  }

  #roots-data-table th.sortable { cursor: pointer; }
  #roots-data-table th.sortable:hover { color: #7cc4ff; }

  #roots-data-table td {
    padding: 0.35em 0.6em;
    border-bottom: 1px solid #333;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #roots-data-table tr:hover { background: rgba(88, 166, 255, 0.04); }
  #roots-data-table tr.selected { background: rgba(88, 166, 255, 0.1); }

  #roots-data-table td[contenteditable="true"] {
    cursor: text;
    outline: none;
    white-space: normal;
    word-break: break-word;
  }

  #roots-data-table td[contenteditable="true"]:focus {
    background: rgba(88, 166, 255, 0.08);
    outline: 1px solid #58a6ff;
    outline-offset: -1px;
  }

  #roots-data-table td.changed {
    background: rgba(255, 214, 102, 0.1);
    border-left: 2px solid #ffe66d;
  }

  #roots-data-table .row-checkbox {
    accent-color: #58a6ff;
  }

  /* â”€â”€ Bulk edit bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .bulk-bar {
    display: none;
    background: #1a1f2e;
    border: 1px solid #58a6ff;
    border-radius: 6px;
    padding: 0.8em 1em;
    margin-bottom: 1em;
    align-items: center;
    gap: 0.5em;
    flex-wrap: wrap;
  }

  .bulk-bar.visible { display: flex; }

  .bulk-bar select, .bulk-bar input[type="text"] {
    padding: 0.4em 0.6em;
    background: #252a34;
    border: 1px solid #444;
    border-radius: 4px;
    color: #e0e0e0;
    font-size: 0.85em;
  }

  .bulk-bar label {
    color: #aaa;
    font-size: 0.85em;
  }

  /* â”€â”€ Paste modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .paste-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  .paste-overlay.open { display: flex; }

  .paste-modal {
    background: #1e2330;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 1.5em;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
    color: #e0e0e0;
  }

  .paste-modal h3 {
    margin: 0 0 0.5em 0;
    color: #58a6ff;
    font-size: 1.1em;
  }

  .paste-modal p {
    font-size: 0.85em;
    color: #aaa;
    margin: 0 0 1em 0;
  }

  .paste-modal textarea {
    width: 100%;
    min-height: 200px;
    padding: 0.6em;
    background: #252a34;
    border: 1px solid #444;
    border-radius: 4px;
    color: #e0e0e0;
    font-family: monospace;
    font-size: 0.85em;
    resize: vertical;
    box-sizing: border-box;
  }

  .paste-modal textarea:focus {
    outline: none;
    border-color: #58a6ff;
  }

  .paste-modal .paste-actions {
    display: flex;
    gap: 0.5em;
    justify-content: flex-end;
    margin-top: 1em;
  }

  .paste-preview {
    margin-top: 1em;
    font-size: 0.8em;
    color: #aaa;
    max-height: 150px;
    overflow-y: auto;
  }

  .paste-preview table {
    width: 100%;
    border-collapse: collapse;
  }

  .paste-preview th, .paste-preview td {
    padding: 0.3em 0.5em;
    border: 1px solid #333;
    text-align: left;
  }

  .paste-preview th { color: #58a6ff; background: #1a1f2e; }

  /* â”€â”€ Status bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .status-bar {
    font-size: 0.8em;
    color: #888;
    padding: 0.5em 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .status-bar .unsaved {
    color: #ffe66d;
  }

  /* â”€â”€ Add column modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .add-col-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  .add-col-overlay.open { display: flex; }

  .add-col-modal {
    background: #1e2330;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 1.5em;
    width: 90%;
    max-width: 400px;
    color: #e0e0e0;
  }

  .add-col-modal h3 {
    margin: 0 0 1em 0;
    color: #58a6ff;
    font-size: 1.1em;
  }

  .add-col-modal input[type="text"] {
    width: 100%;
    padding: 0.5em;
    background: #252a34;
    border: 1px solid #444;
    border-radius: 4px;
    color: #e0e0e0;
    font-size: 0.9em;
    box-sizing: border-box;
  }

  .add-col-modal input[type="text"]:focus {
    outline: none;
    border-color: #58a6ff;
  }

  .add-col-modal .add-col-actions {
    display: flex;
    gap: 0.5em;
    justify-content: flex-end;
    margin-top: 1em;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 1em;
    color: #58a6ff;
    text-decoration: none;
    font-size: 0.9em;
  }

  .back-link:hover { text-decoration: underline; }

  /* â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #roots-admin-loading {
    text-align: center;
    padding: 2em 1em;
    color: #888;
    transition: opacity 0.4s ease;
  }

  #roots-admin-loading.fade-out {
    opacity: 0;
    pointer-events: none;
  }

  #roots-admin-loading .loading-text {
    font-size: 0.9em;
    margin-bottom: 0.8em;
  }

  #roots-admin-loading .progress-bar {
    width: 200px;
    height: 4px;
    background: #333;
    border-radius: 2px;
    overflow: hidden;
    margin: 0 auto;
  }

  #roots-admin-loading .progress-fill {
    height: 100%;
    width: 0%;
    background: #58a6ff;
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  </style>
</head>
<body>

<div class="page-loader">
  <div class="loader-inner">
    <div class="loader-logo">tomika<span class="accent">.bikes</span></div>
    <div class="loader-dots"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div>
  </div>
</div>

<!-- Navigation -->
<nav class="navbar">
  <div class="nav-inner">
    <a href="index.html" class="nav-logo"><span class="logo-icon">ğŸš´</span>tomika<span class="accent">.bikes</span></a>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="planning.html">Planning</a></li>
      <li><a href="roots.html">Roots</a></li>
      <li><a href="blog.html">Blog</a></li>
      <li><a href="photos.html">Photos</a></li>
      <li><a href="journal.html">Journal</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="nav-actions">
      <button class="nav-login-btn" data-auth>
        <svg viewBox="0 0 24 24" fill="none" width="16" height="16"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Sign In
      </button>
    </div>
    <button class="hamburger" aria-label="Toggle menu"><span></span><span></span><span></span></button>
  </div>
</nav>

<div class="mobile-menu">
  <a href="index.html">ğŸ  Home</a>
  <a href="planning.html">ğŸ—ºï¸ Planning</a>
  <a href="roots.html">ğŸšµ Roots</a>
  <a href="blog.html">âœï¸ Blog</a>
  <a href="photos.html">ğŸ“· Photos</a>
  <a href="journal.html">ğŸ“” Journal</a>
  <a href="admin.html">âš™ï¸ Admin</a>
  <button class="btn btn-primary" style="margin-top:.5rem" data-auth>Sign In with Google</button>
</div>

<div class="auth-overlay">
  <div class="auth-modal">
    <button class="auth-close">âœ•</button>
    <h2>Welcome back ğŸ‘‹</h2>
    <p>Sign in to access the admin dashboard</p>
    <button class="google-btn">
      <svg viewBox="0 0 24 24" fill="none" width="20" height="20"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Continue with Google
    </button>
    <p class="auth-note">Firebase auth coming soon</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH GATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="adminGate" class="admin-gate">
  <div class="admin-gate-card">
    <span class="lock-icon">ğŸ”</span>
    <h2>Admin Access Only</h2>
    <p>This panel is restricted to site admins. Sign in with your Google account to continue.</p>
    <button class="btn btn-primary" style="width:100%;justify-content:center;margin-bottom:1rem" data-auth>Sign In with Google</button>
    <button class="btn btn-outline" style="width:100%;justify-content:center;color:var(--color-secondary);border-color:var(--color-secondary)" onclick="unlockAdmin()">ğŸ‘ï¸ Preview Demo Dashboard</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADMIN DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="adminDashboard" style="display:none" class="admin-layout">

  <!-- Sidebar -->
  <div class="admin-sidebar">
    <div class="admin-sidebar-header">
      <div class="footer-logo" style="font-size:1.1rem;margin-bottom:.25rem">ğŸš´ tomika<span style="color:var(--color-accent)">.bikes</span></div>
      <h3>Admin Panel</h3>
    </div>
    <nav class="admin-nav">
      <a href="#" class="active" onclick="showSection('dashboard',this)"><span class="nav-icon">ğŸ“Š</span> Dashboard</a>
      <a href="#" onclick="showSection('posts',this)"><span class="nav-icon">âœï¸</span> Blog Posts</a>
      <a href="#" onclick="showSection('photos',this)"><span class="nav-icon">ğŸ“·</span> Photos</a>
      <a href="#" onclick="showSection('journal',this)"><span class="nav-icon">ğŸ“”</span> Journal</a>
      <a href="#" onclick="showSection('waypoints',this)"><span class="nav-icon">ğŸ—ºï¸</span> Waypoints</a>
      <a href="#" onclick="showSection('roots',this)"><span class="nav-icon">ğŸ—ºï¸</span> Roots Admin</a>
      <a href="#" onclick="showSection('settings',this)"><span class="nav-icon">âš™ï¸</span> Settings</a>
      <a href="index.html" style="margin-top:2rem;border-top:1px solid rgba(255,255,255,.1);padding-top:1rem"><span class="nav-icon">ğŸ </span> View Site</a>
    </nav>
  </div>

  <!-- Main -->
  <main class="admin-main">

    <!-- â”€â”€ Dashboard â”€â”€ -->
    <div id="section-dashboard" class="admin-section">
      <div class="admin-header">
        <h1>Dashboard ğŸ“Š</h1>
        <p>Welcome back! Here's what's happening on your site.</p>
      </div>

      <div class="admin-stats-grid">
        <div class="admin-stat-card">
          <div class="stat-icon">âœï¸</div>
          <span class="stat-value">8</span>
          <div class="stat-label">Blog Posts</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-icon">ğŸ“·</div>
          <span class="stat-value">24</span>
          <div class="stat-label">Photos</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-icon">ğŸ“”</div>
          <span class="stat-value">3</span>
          <div class="stat-label">Journal Entries</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-icon">ğŸ“</div>
          <span class="stat-value">9</span>
          <div class="stat-label">Waypoints</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="admin-section">
        <h2>âš¡ Quick Actions</h2>
        <div class="quick-actions">
          <div class="quick-action" onclick="showSection('posts',null);TomikaBikes.showToast('Opening new post editor','info')">
            <div class="qa-icon">âœï¸</div>
            <h4>New Blog Post</h4>
            <p>Write and publish a post</p>
          </div>
          <div class="quick-action" onclick="TomikaBikes.showToast('Photo upload coming soon','info')">
            <div class="qa-icon">ğŸ“¤</div>
            <h4>Upload Photos</h4>
            <p>Add new gallery images</p>
          </div>
          <div class="quick-action" onclick="showSection('journal',null)">
            <div class="qa-icon">ğŸ“”</div>
            <h4>New Journal Entry</h4>
            <p>Write a private entry</p>
          </div>
          <div class="quick-action" onclick="TomikaBikes.showToast('Waypoint editor coming soon','info')">
            <div class="qa-icon">ğŸ“</div>
            <h4>Add Waypoint</h4>
            <p>Update the trip map</p>
          </div>
        </div>
      </div>

      <!-- Recent activity -->
      <div class="admin-table-card">
        <h3>Recent Activity</h3>
        <div class="activity-list">
          <div class="activity-item">
            <div class="activity-icon">âœï¸</div>
            <div class="activity-body">
              <strong>New blog post published</strong>
              <span>"The Grand Plan: Cycling Across Europe"</span>
            </div>
            <div class="activity-time">2h ago</div>
          </div>
          <div class="activity-item">
            <div class="activity-icon">ğŸ“·</div>
            <div class="activity-body">
              <strong>12 photos uploaded</strong>
              <span>Album: Pre-trip preparation</span>
            </div>
            <div class="activity-time">1d ago</div>
          </div>
          <div class="activity-item">
            <div class="activity-icon">ğŸ“”</div>
            <div class="activity-body">
              <strong>Journal entry added</strong>
              <span>"Valentine's Day â€“ Pre-trip nerves"</span>
            </div>
            <div class="activity-time">2d ago</div>
          </div>
          <div class="activity-item">
            <div class="activity-icon">ğŸ“</div>
            <div class="activity-body">
              <strong>Waypoint updated</strong>
              <span>Istanbul, Turkey â€“ added notes</span>
            </div>
            <div class="activity-time">3d ago</div>
          </div>
        </div>
      </div>

      <!-- Posts table -->
      <div class="admin-table-card">
        <h3>Latest Blog Posts</h3>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Author</th>
              <th>Category</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>The Grand Plan: Cycling Across Europe</td>
              <td>Tomika</td>
              <td>Planning</td>
              <td><span class="status-badge status-published">Published</span></td>
              <td><button class="btn" style="padding:.3rem .75rem;font-size:.75rem" onclick="TomikaBikes.showToast('Edit coming soon','info')">Edit</button></td>
            </tr>
            <tr>
              <td>Packing Light: Our Bikepacking Setup</td>
              <td>Partner</td>
              <td>Gear</td>
              <td><span class="status-badge status-published">Published</span></td>
              <td><button class="btn" style="padding:.3rem .75rem;font-size:.75rem" onclick="TomikaBikes.showToast('Edit coming soon','info')">Edit</button></td>
            </tr>
            <tr>
              <td>Why We're Doing This Together</td>
              <td>Tomika</td>
              <td>Stories</td>
              <td><span class="status-badge status-draft">Draft</span></td>
              <td><button class="btn" style="padding:.3rem .75rem;font-size:.75rem" onclick="TomikaBikes.showToast('Edit coming soon','info')">Edit</button></td>
            </tr>
            <tr>
              <td>Cycling Nutrition on the Road</td>
              <td>Tomika</td>
              <td>Food</td>
              <td><span class="status-badge status-draft">Draft</span></td>
              <td><button class="btn" style="padding:.3rem .75rem;font-size:.75rem" onclick="TomikaBikes.showToast('Edit coming soon','info')">Edit</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Blog Posts â”€â”€ -->
    <div id="section-posts" class="admin-section" style="display:none">
      <div class="admin-header">
        <h1>Blog Posts âœï¸</h1>
        <p>Create, edit, and manage your travel blog posts.</p>
      </div>

      <div class="new-post-form">
        <h3 style="margin-bottom:1.5rem">New Blog Post</h3>
        <div class="form-group">
          <label>Post Title</label>
          <input type="text" class="form-control" placeholder="An Unforgettable Day in the Alps..." />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select class="form-control">
              <option>Planning</option>
              <option>Gear</option>
              <option>Stories</option>
              <option>Food</option>
              <option>Tips</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select class="form-control">
              <option>Draft</option>
              <option>Published</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Content</label>
          <textarea class="form-control" rows="10" placeholder="Write your post here..."></textarea>
        </div>
        <div style="display:flex;gap:1rem;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="TomikaBikes.showToast('Post saved! Firebase sync coming soon','success')">ğŸ’¾ Save Post</button>
          <button class="btn" style="background:var(--color-gray-200)" onclick="TomikaBikes.showToast('Draft saved','info')">Save Draft</button>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Photos â”€â”€ -->
    <div id="section-photos" class="admin-section" style="display:none">
      <div class="admin-header">
        <h1>Photos ğŸ“·</h1>
        <p>Upload and manage your travel gallery.</p>
      </div>
      <div class="upload-zone" style="background:var(--color-white)" onclick="TomikaBikes.showToast('Firebase storage upload coming soon','info')">
        <div class="upload-icon" style="font-size:2.5rem">ğŸ“¤</div>
        <h3>Upload Photos</h3>
        <p>Drag & drop or click to upload. Firebase Storage integration coming soon.</p>
      </div>
    </div>

    <!-- â”€â”€ Journal â”€â”€ -->
    <div id="section-journal" class="admin-section" style="display:none">
      <div class="admin-header">
        <h1>Journal ğŸ“”</h1>
        <p>Manage private journal entries.</p>
      </div>
      <p style="color:var(--color-gray-600)">Journal entries are managed from the <a href="journal.html" style="color:var(--color-secondary)">Journal page</a>.</p>
    </div>

    <!-- â”€â”€ Waypoints â”€â”€ -->
    <div id="section-waypoints" class="admin-section" style="display:none">
      <div class="admin-header">
        <h1>Waypoints ğŸ—ºï¸</h1>
        <p>Add and manage trip waypoints on the planning map.</p>
      </div>
      <p style="color:var(--color-gray-600)">Waypoints are managed from the <a href="planning.html" style="color:var(--color-secondary)">Planning page</a>.</p>
    </div>

    <!-- â”€â”€ Settings â”€â”€ -->
    <div id="section-settings" class="admin-section" style="display:none">
      <div class="admin-header">
        <h1>Settings âš™ï¸</h1>
        <p>Site configuration and Firebase setup.</p>
      </div>
      <div class="new-post-form">
        <h3 style="margin-bottom:1.5rem">Site Settings</h3>
        <div class="form-group">
          <label>Site Name</label>
          <input type="text" class="form-control" value="tomika.bikes" />
        </div>
        <div class="form-group">
          <label>Site Tagline</label>
          <input type="text" class="form-control" value="A cycling adventure blog" />
        </div>
        <div class="form-group">
          <label>Firebase Project ID</label>
          <input type="text" class="form-control" placeholder="your-firebase-project-id" />
        </div>
        <div class="form-group">
          <label>Firebase API Key</label>
          <input type="text" class="form-control" placeholder="AIza..." />
        </div>
        <div class="form-group">
          <label>Authorized Emails (one per line)</label>
          <textarea class="form-control" rows="3" placeholder="admin1@gmail.com&#10;admin2@gmail.com"></textarea>
        </div>
        <button class="btn btn-primary" onclick="TomikaBikes.showToast('Settings saved! Firebase integration pending','success')">ğŸ’¾ Save Settings</button>
      </div>
    </div>

    <!-- â”€â”€ Roots Admin â”€â”€ -->
    <div id="section-roots" class="admin-section" style="display:none">
      <div class="admin-header">
        <h1>Roots Admin ğŸ—ºï¸</h1>
        <p>Manage Firestore data for the Roots Bike Route Planner.</p>
      </div>

      <!-- Roots auth gate (Firebase sign-in required) -->
      <div id="roots-auth-gate" style="text-align:center;padding:3em 1em;color:#888;">
        <h2>Roots Firestore Access</h2>
        <p>Sign in with your admin Google account to manage Roots data.</p>
        <button class="roots-btn" id="roots-admin-auth-btn" style="font-size:1.1em;padding:0.6em 1.5em;margin-top:1em;">Sign In with Google</button>
        <div id="roots-admin-auth-status" style="margin-top:1em;font-size:0.85em;"></div>
      </div>

      <!-- Main admin content (hidden until auth) -->
      <div id="roots-admin-content" style="display:none">
        <a href="roots.html" class="back-link">&larr; Back to Roots</a>

        <!-- Collection tabs -->
        <div class="collection-tabs">
          <button class="collection-tab active" data-collection="points">Points</button>
          <button class="collection-tab" data-collection="routes">Routes</button>
        </div>

        <!-- Filter & actions bar -->
        <div class="filter-bar">
          <select id="roots-group-filter">
            <option value="">All groups</option>
          </select>
          <input type="text" id="roots-search-input" placeholder="Search by name..." style="min-width:200px;">
          <span style="flex:1;"></span>
          <button class="roots-btn" id="roots-add-col-btn" title="Add a new metadata column">+ Column</button>
          <button class="roots-btn" id="roots-paste-btn" title="Paste data from Excel/Sheets">Paste from Excel</button>
        </div>

        <!-- Bulk edit bar (visible when rows selected) -->
        <div class="bulk-bar" id="roots-bulk-bar">
          <label><span id="roots-selected-count">0</span> selected</label>
          <select id="roots-bulk-field"></select>
          <input type="text" id="roots-bulk-value" placeholder="New value...">
          <button class="roots-btn primary" id="roots-bulk-apply-btn">Apply</button>
          <button class="roots-btn" id="roots-bulk-clear-btn">Clear Selection</button>
        </div>

        <!-- Loading overlay -->
        <div id="roots-admin-loading">
          <div class="loading-text" id="roots-admin-loading-text">Loading data...</div>
          <div class="progress-bar"><div class="progress-fill" id="roots-admin-progress-fill"></div></div>
        </div>

        <!-- Data table -->
        <div class="admin-table-wrap">
          <table id="roots-data-table">
            <thead><tr id="roots-data-thead-row"></tr></thead>
            <tbody id="roots-data-tbody"></tbody>
          </table>
        </div>

        <!-- Status bar -->
        <div class="status-bar">
          <span id="roots-table-status">Loading...</span>
          <span>
            <button class="roots-btn primary" id="roots-save-btn" disabled>Save Changes</button>
            <button class="roots-btn" id="roots-discard-btn" disabled>Discard</button>
          </span>
        </div>
      </div>

      <!-- Paste from Excel modal -->
      <div class="paste-overlay" id="roots-paste-overlay">
        <div class="paste-modal">
          <h3>Paste from Excel / Google Sheets</h3>
          <p>Copy cells from a spreadsheet and paste below. First row should be headers. Tab-separated values are auto-detected.</p>
          <textarea id="roots-paste-textarea" placeholder="Paste your data here (Ctrl+V / Cmd+V)..."></textarea>
          <div class="paste-preview" id="roots-paste-preview"></div>
          <div class="paste-actions">
            <button class="roots-btn" id="roots-paste-cancel-btn">Cancel</button>
            <button class="roots-btn primary" id="roots-paste-apply-btn" disabled>Apply to Selected</button>
          </div>
        </div>
      </div>

      <!-- Add column modal -->
      <div class="add-col-overlay" id="roots-add-col-overlay">
        <div class="add-col-modal">
          <h3>Add Metadata Column</h3>
          <label style="display:block;font-size:0.85em;color:#aaa;margin-bottom:0.5em;">Column name (will be stored in metadata)</label>
          <input type="text" id="roots-add-col-name" placeholder="e.g. type, rating, notes...">
          <div class="add-col-actions">
            <button class="roots-btn" id="roots-add-col-cancel-btn">Cancel</button>
            <button class="roots-btn primary" id="roots-add-col-confirm-btn">Add Column</button>
          </div>
        </div>
      </div>

    </div>

  </main>
</div>

<!-- Firebase SDK for Roots admin -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-config.js"></script>

<script src="js/main.js"></script>
<script>
  function unlockAdmin() {
    document.getElementById('adminGate').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'grid';
    TomikaBikes.showToast('Demo admin dashboard â€“ sign in for full access', 'info');
  }

  function showSection(name, linkEl) {
    // Hide all sections
    document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
    // Show target
    const target = document.getElementById(`section-${name}`);
    if (target) target.style.display = 'block';
    // Update nav
    if (linkEl) {
      document.querySelectorAll('.admin-nav a').forEach(a => a.classList.remove('active'));
      linkEl.classList.add('active');
    }
  }

  // Attach auth unlock to sign-in buttons inside gate
  document.querySelectorAll('[data-auth]').forEach(btn => {
    btn.addEventListener('click', () => {
      // If on admin page, also show preview
      if (document.getElementById('adminGate') && document.getElementById('adminGate').style.display !== 'none') {
        unlockAdmin();
      }
    });
  });
</script>

<script>
// â”€â”€ Roots Admin Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let db = null;
  let currentUser = null;
  let currentCollection = 'points';  // 'points' or 'routes'
  let allDocs = [];         // raw Firestore docs: { id, data }
  let filteredDocs = [];    // after filter/search
  let columns = [];         // ordered column names to display
  let changes = {};         // docId -> { field: newValue, ... }
  let selectedIds = new Set();

  // Fixed (non-editable) fields per collection
  const FIXED_FIELDS = {
    points: ['name', 'lat', 'lon', 'url', 'fileName'],
    routes: ['fileName', 'storagePath']
  };

  // Fields we never show in the table
  const HIDDEN_FIELDS = ['gpxContent', 'uploadedAt', 'storagePath'];

  // â”€â”€ Firebase Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let authLoaded = false;

  function loadAuthSDK() {
    if (authLoaded) return Promise.resolve();
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js';
      script.onload = () => { authLoaded = true; resolve(); };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  function setupAuth() {
    firebase.auth().onAuthStateChanged(user => {
      currentUser = user;
      if (user && user.email === ADMIN_EMAIL) {
        document.getElementById('roots-auth-gate').style.display = 'none';
        document.getElementById('roots-admin-content').style.display = 'block';
        loadCollection();
      } else if (user) {
        document.getElementById('roots-admin-auth-status').textContent = 'Access denied. This account is not an admin.';
        document.getElementById('roots-admin-auth-btn').textContent = 'Sign Out';
        document.getElementById('roots-admin-auth-btn').onclick = () => firebase.auth().signOut();
      } else {
        document.getElementById('roots-auth-gate').style.display = 'block';
        document.getElementById('roots-admin-content').style.display = 'none';
        document.getElementById('roots-admin-auth-btn').textContent = 'Sign In with Google';
        document.getElementById('roots-admin-auth-status').textContent = '';
      }
    });
  }

  function initFirebase() {
    if (typeof FIREBASE_CONFIG === 'undefined' || !FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === 'YOUR_API_KEY') {
      document.getElementById('roots-admin-auth-status').textContent = 'Firebase not configured.';
      return;
    }

    try {
      firebase.initializeApp(FIREBASE_CONFIG);
    } catch(e) {
      // App already initialized - use existing instance
    }
    db = firebase.firestore();

    // Enable local persistence â€” repeat visits serve data from cache first
    db.enablePersistence({ synchronizeTabs: true }).catch(err => {
      if (err.code !== 'failed-precondition' && err.code !== 'unimplemented') {
        console.warn('Firestore persistence error:', err);
      }
    });

    const authBtn = document.getElementById('roots-admin-auth-btn');

    // Lazy-load Auth SDK only when user clicks Sign In
    authBtn.addEventListener('click', () => {
      if (authLoaded && currentUser) {
        firebase.auth().signOut();
        return;
      }
      authBtn.disabled = true;
      authBtn.textContent = 'Loading...';
      loadAuthSDK()
        .then(() => {
          setupAuth();
          if (!currentUser) {
            const provider = new firebase.auth.GoogleAuthProvider();
            return firebase.auth().signInWithPopup(provider);
          }
        })
        .catch(err => {
          console.error('Auth error:', err);
          document.getElementById('roots-admin-auth-status').textContent = 'Sign-in failed: ' + err.message;
        })
        .finally(() => {
          authBtn.disabled = false;
        });
    });
  }

  // â”€â”€ Loading progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showLoadingProgress(pct, text) {
    const fill = document.getElementById('roots-admin-progress-fill');
    const loadingText = document.getElementById('roots-admin-loading-text');
    const loadingEl = document.getElementById('roots-admin-loading');
    if (fill) fill.style.width = pct + '%';
    if (loadingText) loadingText.textContent = text || 'Loading data...';
    if (loadingEl && pct >= 100) {
      loadingEl.classList.add('fade-out');
      setTimeout(() => { loadingEl.style.display = 'none'; }, 400);
    } else if (loadingEl && pct < 100) {
      loadingEl.style.display = '';
      loadingEl.classList.remove('fade-out');
    }
  }

  // â”€â”€ Load Collection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadCollection() {
    allDocs = [];
    changes = {};
    selectedIds.clear();
    updateBulkBar();
    updateSaveButtons();
    showLoadingProgress(10, 'Fetching ' + currentCollection + '...');

    db.collection(currentCollection).orderBy('uploadedAt', 'desc').get()
      .then(snapshot => {
        showLoadingProgress(50, 'Processing ' + snapshot.size + ' documents...');
        snapshot.forEach(doc => {
          allDocs.push({ id: doc.id, data: doc.data() });
        });
        detectColumns();
        showLoadingProgress(70, 'Building filters...');
        populateGroupFilter();
        showLoadingProgress(85, 'Rendering table...');
        applyFilters();
        showLoadingProgress(100, 'Done');
        document.getElementById('roots-table-status').textContent = allDocs.length + ' documents loaded';
      })
      .catch(err => {
        console.error('Load error:', err);
        showLoadingProgress(100, 'Error');
        document.getElementById('roots-table-status').textContent = 'Error loading data: ' + err.message;
      });
  }

  // â”€â”€ Detect columns from all docs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function detectColumns() {
    const colSet = new Set();
    const fixed = FIXED_FIELDS[currentCollection] || [];

    allDocs.forEach(doc => {
      const d = doc.data;
      // Top-level fields
      Object.keys(d).forEach(key => {
        if (!HIDDEN_FIELDS.includes(key) && key !== 'metadata') {
          colSet.add(key);
        }
      });
      // Metadata fields (flattened with metadata. prefix for display)
      if (d.metadata && typeof d.metadata === 'object') {
        Object.keys(d.metadata).forEach(key => {
          colSet.add('metadata.' + key);
        });
      }
    });

    // Order: fixed fields first, then metadata fields alphabetically
    const metaCols = [];
    const otherCols = [];
    colSet.forEach(col => {
      if (fixed.includes(col)) return; // handled separately
      if (col.startsWith('metadata.')) metaCols.push(col);
      else otherCols.push(col);
    });

    metaCols.sort();
    otherCols.sort();
    columns = [...fixed.filter(f => colSet.has(f)), ...otherCols, ...metaCols];
  }

  // â”€â”€ Populate group filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function populateGroupFilter() {
    const select = document.getElementById('roots-group-filter');
    select.innerHTML = '<option value="">All groups</option>';

    const groups = new Set();
    allDocs.forEach(doc => {
      const fn = doc.data.fileName;
      if (fn) groups.add(fn);
    });

    Array.from(groups).sort().forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      select.appendChild(opt);
    });
  }

  // â”€â”€ Apply filters & render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyFilters() {
    const groupVal = document.getElementById('roots-group-filter').value;
    const searchVal = document.getElementById('roots-search-input').value.toLowerCase().trim();

    filteredDocs = allDocs.filter(doc => {
      if (groupVal && doc.data.fileName !== groupVal) return false;
      if (searchVal) {
        const name = (doc.data.name || doc.data.fileName || '').toLowerCase();
        if (!name.includes(searchVal)) return false;
      }
      return true;
    });

    renderTable();
  }

  // â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable() {
    const thead = document.getElementById('roots-data-thead-row');
    const tbody = document.getElementById('roots-data-tbody');
    const fixed = FIXED_FIELDS[currentCollection] || [];

    // Header
    let headerHtml = '<th><input type="checkbox" id="select-all"></th>';
    columns.forEach(col => {
      const label = col.startsWith('metadata.') ? col.slice(9) : col;
      headerHtml += '<th class="sortable" data-col="' + escapeAttr(col) + '">' + escapeHtml(label) + '</th>';
    });
    thead.innerHTML = headerHtml;

    // Body
    let bodyHtml = '';
    filteredDocs.forEach(doc => {
      const isSelected = selectedIds.has(doc.id);
      bodyHtml += '<tr data-id="' + escapeAttr(doc.id) + '"' + (isSelected ? ' class="selected"' : '') + '>';
      bodyHtml += '<td><input type="checkbox" class="row-checkbox" data-id="' + escapeAttr(doc.id) + '"' + (isSelected ? ' checked' : '') + '></td>';

      columns.forEach(col => {
        const val = getDocValue(doc, col);
        const displayVal = val != null ? String(val) : '';
        const isEditable = !fixed.includes(col);
        const changeKey = col;
        const isChanged = changes[doc.id] && changes[doc.id][changeKey] !== undefined;

        if (isEditable) {
          bodyHtml += '<td contenteditable="true" data-id="' + escapeAttr(doc.id) + '" data-col="' + escapeAttr(col) + '"' + (isChanged ? ' class="changed"' : '') + '>' + escapeHtml(isChanged ? String(changes[doc.id][changeKey]) : displayVal) + '</td>';
        } else {
          bodyHtml += '<td>' + escapeHtml(displayVal) + '</td>';
        }
      });

      bodyHtml += '</tr>';
    });
    tbody.innerHTML = bodyHtml;

    // Update select-all state
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
      selectAll.checked = filteredDocs.length > 0 && filteredDocs.every(d => selectedIds.has(d.id));
    }

    // Populate bulk field dropdown & init event delegation (once)
    populateBulkFieldDropdown();
    initTableEventDelegation();
  }

  // â”€â”€ Get value from doc by column name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getDocValue(doc, col) {
    if (col.startsWith('metadata.')) {
      const key = col.slice(9);
      return doc.data.metadata ? doc.data.metadata[key] : undefined;
    }
    return doc.data[col];
  }

  // â”€â”€ Table event delegation (bound once, not per-render) â”€â”€
  let _tableEventsInitialized = false;

  function initTableEventDelegation() {
    if (_tableEventsInitialized) return;
    _tableEventsInitialized = true;

    const table = document.getElementById('roots-data-table');

    // Delegate change events (checkboxes)
    table.addEventListener('change', (e) => {
      const target = e.target;

      // Select-all checkbox
      if (target.id === 'select-all') {
        filteredDocs.forEach(doc => {
          if (target.checked) selectedIds.add(doc.id);
          else selectedIds.delete(doc.id);
        });
        renderTable();
        updateBulkBar();
        return;
      }

      // Individual row checkboxes
      if (target.classList.contains('row-checkbox')) {
        const id = target.dataset.id;
        if (target.checked) selectedIds.add(id);
        else selectedIds.delete(id);
        target.closest('tr').classList.toggle('selected', target.checked);
        updateBulkBar();
        const sa = document.getElementById('select-all');
        if (sa) sa.checked = filteredDocs.length > 0 && filteredDocs.every(d => selectedIds.has(d.id));
      }
    });

    // Delegate blur events (inline cell editing)
    table.addEventListener('focusout', (e) => {
      const td = e.target;
      if (td.tagName !== 'TD' || td.getAttribute('contenteditable') !== 'true') return;

      const docId = td.dataset.id;
      const col = td.dataset.col;
      const originalDoc = allDocs.find(d => d.id === docId);
      const originalVal = originalDoc ? String(getDocValue(originalDoc, col) || '') : '';
      const newVal = td.textContent.trim();

      if (newVal !== originalVal) {
        if (!changes[docId]) changes[docId] = {};
        changes[docId][col] = newVal;
        td.classList.add('changed');
      } else {
        if (changes[docId]) {
          delete changes[docId][col];
          if (Object.keys(changes[docId]).length === 0) delete changes[docId];
        }
        td.classList.remove('changed');
      }
      updateSaveButtons();
    });

    // Delegate keydown events (Enter/Tab in editable cells)
    table.addEventListener('keydown', (e) => {
      const td = e.target;
      if (td.tagName !== 'TD' || td.getAttribute('contenteditable') !== 'true') return;

      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        td.blur();
      }
      if (e.key === 'Tab') {
        e.preventDefault();
        const allEditable = Array.from(table.querySelectorAll('td[contenteditable="true"]'));
        const idx = allEditable.indexOf(td);
        const next = e.shiftKey ? allEditable[idx - 1] : allEditable[idx + 1];
        if (next) {
          td.blur();
          next.focus();
        }
      }
    });
  }

  // â”€â”€ Bulk edit bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateBulkBar() {
    const bar = document.getElementById('roots-bulk-bar');
    const count = selectedIds.size;
    document.getElementById('roots-selected-count').textContent = count;
    bar.classList.toggle('visible', count > 0);
  }

  function populateBulkFieldDropdown() {
    const select = document.getElementById('roots-bulk-field');
    const fixed = FIXED_FIELDS[currentCollection] || [];
    select.innerHTML = '';

    columns.forEach(col => {
      if (fixed.includes(col)) return;
      const opt = document.createElement('option');
      opt.value = col;
      opt.textContent = col.startsWith('metadata.') ? col.slice(9) : col;
      select.appendChild(opt);
    });
  }

  function applyBulkEdit() {
    const field = document.getElementById('roots-bulk-field').value;
    const value = document.getElementById('roots-bulk-value').value.trim();
    if (!field) return;

    selectedIds.forEach(docId => {
      const originalDoc = allDocs.find(d => d.id === docId);
      const originalVal = originalDoc ? String(getDocValue(originalDoc, field) || '') : '';

      if (value !== originalVal) {
        if (!changes[docId]) changes[docId] = {};
        changes[docId][field] = value;
      } else {
        if (changes[docId]) {
          delete changes[docId][field];
          if (Object.keys(changes[docId]).length === 0) delete changes[docId];
        }
      }
    });

    renderTable();
    updateSaveButtons();
    document.getElementById('roots-bulk-value').value = '';
  }

  // â”€â”€ Save changes to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveChanges() {
    const docIds = Object.keys(changes);
    if (docIds.length === 0) return;

    const saveBtn = document.getElementById('roots-save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    // Firestore batch limit is 500; chunk if needed
    const chunks = [];
    for (let i = 0; i < docIds.length; i += 400) {
      chunks.push(docIds.slice(i, i + 400));
    }

    let promise = Promise.resolve();
    chunks.forEach(chunk => {
      promise = promise.then(() => {
        const batch = db.batch();
        chunk.forEach(docId => {
          const docRef = db.collection(currentCollection).doc(docId);
          const docChanges = changes[docId];
          const update = {};

          Object.entries(docChanges).forEach(([col, val]) => {
            if (col.startsWith('metadata.')) {
              const key = col.slice(9);
              update['metadata.' + key] = val;
            } else {
              update[col] = val;
            }
          });

          batch.update(docRef, update);
        });
        return batch.commit();
      });
    });

    promise
      .then(() => {
        // Update local data
        Object.entries(changes).forEach(([docId, docChanges]) => {
          const doc = allDocs.find(d => d.id === docId);
          if (!doc) return;
          Object.entries(docChanges).forEach(([col, val]) => {
            if (col.startsWith('metadata.')) {
              const key = col.slice(9);
              if (!doc.data.metadata) doc.data.metadata = {};
              doc.data.metadata[key] = val;
            } else {
              doc.data[col] = val;
            }
          });
        });

        changes = {};
        renderTable();
        updateSaveButtons();
        saveBtn.textContent = 'Saved!';
        document.getElementById('roots-table-status').textContent = allDocs.length + ' documents loaded â€” changes saved';
        setTimeout(() => { saveBtn.textContent = 'Save Changes'; }, 2000);
      })
      .catch(err => {
        console.error('Save error:', err);
        alert('Save failed: ' + err.message);
        saveBtn.textContent = 'Save Changes';
        saveBtn.disabled = false;
      });
  }

  function discardChanges() {
    if (!confirm('Discard all unsaved changes?')) return;
    changes = {};
    renderTable();
    updateSaveButtons();
  }

  function updateSaveButtons() {
    const count = Object.keys(changes).length;
    document.getElementById('roots-save-btn').disabled = count === 0;
    document.getElementById('roots-discard-btn').disabled = count === 0;

    const status = document.getElementById('roots-table-status');
    if (count > 0) {
      status.innerHTML = allDocs.length + ' documents loaded â€” <span class="unsaved">' + count + ' document' + (count > 1 ? 's' : '') + ' with unsaved changes</span>';
    } else {
      status.textContent = allDocs.length + ' documents loaded';
    }
  }

  // â”€â”€ Paste from Excel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openPasteModal() {
    document.getElementById('roots-paste-textarea').value = '';
    document.getElementById('roots-paste-preview').innerHTML = '';
    document.getElementById('roots-paste-apply-btn').disabled = true;
    document.getElementById('roots-paste-overlay').classList.add('open');
    document.getElementById('roots-paste-textarea').focus();
  }

  function closePasteModal() {
    document.getElementById('roots-paste-overlay').classList.remove('open');
  }

  function parsePastedData(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return null;

    const headers = lines[0].split('\t').map(h => h.trim());
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split('\t').map(v => v.trim());
      if (values.length === 0 || (values.length === 1 && !values[0])) continue;
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = values[idx] || '';
      });
      rows.push(row);
    }

    return { headers, rows };
  }

  function previewPaste() {
    const text = document.getElementById('roots-paste-textarea').value;
    const parsed = parsePastedData(text);
    const previewEl = document.getElementById('roots-paste-preview');
    const applyBtn = document.getElementById('roots-paste-apply-btn');

    if (!parsed || parsed.rows.length === 0) {
      previewEl.innerHTML = '<em>No valid data detected. Make sure first row is headers and data is tab-separated.</em>';
      applyBtn.disabled = true;
      return;
    }

    // Check for a match key (name, or lat+lon)
    const hasName = parsed.headers.some(h => h.toLowerCase() === 'name');
    const matchInfo = hasName ? 'Matching by <strong>name</strong>' : 'Will update selected rows in order';

    let html = '<p>' + matchInfo + ' &mdash; ' + parsed.rows.length + ' row(s) detected</p>';
    html += '<table><tr>';
    parsed.headers.forEach(h => { html += '<th>' + escapeHtml(h) + '</th>'; });
    html += '</tr>';
    parsed.rows.slice(0, 5).forEach(row => {
      html += '<tr>';
      parsed.headers.forEach(h => { html += '<td>' + escapeHtml(row[h] || '') + '</td>'; });
      html += '</tr>';
    });
    if (parsed.rows.length > 5) {
      html += '<tr><td colspan="' + parsed.headers.length + '" style="text-align:center;color:#666;">... and ' + (parsed.rows.length - 5) + ' more rows</td></tr>';
    }
    html += '</table>';

    previewEl.innerHTML = html;
    applyBtn.disabled = false;
  }

  function applyPaste() {
    const text = document.getElementById('roots-paste-textarea').value;
    const parsed = parsePastedData(text);
    if (!parsed) return;

    const hasName = parsed.headers.some(h => h.toLowerCase() === 'name');
    const nameHeader = parsed.headers.find(h => h.toLowerCase() === 'name');

    // Determine which columns are being updated (exclude 'name' as it's the match key)
    const updateHeaders = parsed.headers.filter(h => h.toLowerCase() !== 'name');

    // Ensure columns exist for any new metadata fields
    updateHeaders.forEach(h => {
      // Check if it's a known top-level field or needs metadata. prefix
      const col = resolveColumnName(h);
      if (!columns.includes(col)) {
        columns.push(col);
      }
    });

    if (hasName) {
      // Match by name
      parsed.rows.forEach(row => {
        const nameVal = row[nameHeader];
        const doc = allDocs.find(d => (d.data.name || d.data.fileName || '') === nameVal);
        if (!doc) return;

        updateHeaders.forEach(h => {
          const col = resolveColumnName(h);
          const originalVal = String(getDocValue(doc, col) || '');
          const newVal = row[h] || '';
          if (newVal !== originalVal) {
            if (!changes[doc.id]) changes[doc.id] = {};
            changes[doc.id][col] = newVal;
          }
        });
      });
    } else {
      // Apply to selected rows in order
      const selectedDocs = filteredDocs.filter(d => selectedIds.has(d.id));
      parsed.rows.forEach((row, idx) => {
        if (idx >= selectedDocs.length) return;
        const doc = selectedDocs[idx];

        updateHeaders.forEach(h => {
          const col = resolveColumnName(h);
          const originalVal = String(getDocValue(doc, col) || '');
          const newVal = row[h] || '';
          if (newVal !== originalVal) {
            if (!changes[doc.id]) changes[doc.id] = {};
            changes[doc.id][col] = newVal;
          }
        });
      });
    }

    closePasteModal();
    renderTable();
    updateSaveButtons();
  }

  // Resolve a pasted header name to an internal column name
  function resolveColumnName(header) {
    // If it already matches a column, use it
    if (columns.includes(header)) return header;
    if (columns.includes('metadata.' + header)) return 'metadata.' + header;
    // Check top-level fields
    const topLevel = ['name', 'lat', 'lon', 'url', 'fileName'];
    if (topLevel.includes(header)) return header;
    // Default to metadata
    return 'metadata.' + header;
  }

  // â”€â”€ Add column â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openAddColumnModal() {
    document.getElementById('roots-add-col-name').value = '';
    document.getElementById('roots-add-col-overlay').classList.add('open');
    document.getElementById('roots-add-col-name').focus();
  }

  function closeAddColumnModal() {
    document.getElementById('roots-add-col-overlay').classList.remove('open');
  }

  function addColumn() {
    const name = document.getElementById('roots-add-col-name').value.trim();
    if (!name) return;

    const col = 'metadata.' + name;
    if (columns.includes(col)) {
      alert('Column "' + name + '" already exists.');
      return;
    }

    columns.push(col);
    closeAddColumnModal();
    renderTable();
  }

  // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function escapeAttr(str) {
    return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // â”€â”€ Event Binding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Collection tabs
  document.querySelectorAll('.collection-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      if (Object.keys(changes).length > 0) {
        if (!confirm('You have unsaved changes. Switch collection and discard them?')) return;
      }
      document.querySelectorAll('.collection-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentCollection = tab.dataset.collection;
      loadCollection();
    });
  });

  // Filters (search is debounced to avoid excessive re-renders on every keystroke)
  let _searchTimer = null;
  document.getElementById('roots-group-filter').addEventListener('change', applyFilters);
  document.getElementById('roots-search-input').addEventListener('input', () => {
    if (_searchTimer) clearTimeout(_searchTimer);
    _searchTimer = setTimeout(applyFilters, 150);
  });

  // Bulk edit
  document.getElementById('roots-bulk-apply-btn').addEventListener('click', applyBulkEdit);
  document.getElementById('roots-bulk-clear-btn').addEventListener('click', () => {
    selectedIds.clear();
    updateBulkBar();
    renderTable();
  });

  // Save / Discard
  document.getElementById('roots-save-btn').addEventListener('click', saveChanges);
  document.getElementById('roots-discard-btn').addEventListener('click', discardChanges);

  // Paste modal
  document.getElementById('roots-paste-btn').addEventListener('click', openPasteModal);
  document.getElementById('roots-paste-cancel-btn').addEventListener('click', closePasteModal);
  document.getElementById('roots-paste-apply-btn').addEventListener('click', applyPaste);
  document.getElementById('roots-paste-textarea').addEventListener('input', previewPaste);
  document.getElementById('roots-paste-overlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('roots-paste-overlay')) closePasteModal();
  });

  // Add column modal
  document.getElementById('roots-add-col-btn').addEventListener('click', openAddColumnModal);
  document.getElementById('roots-add-col-cancel-btn').addEventListener('click', closeAddColumnModal);
  document.getElementById('roots-add-col-confirm-btn').addEventListener('click', addColumn);
  document.getElementById('roots-add-col-name').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') addColumn();
  });
  document.getElementById('roots-add-col-overlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('roots-add-col-overlay')) closeAddColumnModal();
  });

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  initFirebase();
})();

</script>
</body>
</html>
